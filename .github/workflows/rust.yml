name: net-tap test

on: [push]

jobs:
  test-net-tap:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libpcap-dev

    - name: Build all binaries
      run: cargo build --verbose --bins

    - name: Start net-tap (listen lo)
      run: |
        sudo ./target/debug/net-tap > capture.log 2>&1 &
        echo $! > tap.pid
        sleep 2

    - name: Start echo server
      run: |
        ./target/debug/echos > server.log 2>&1 &
        echo $! > server.pid
        sleep 2

    - name: Run echo client
      run: |
        ./target/debug/echoc > client.log 2>&1
        cat client.log
        sleep 5

    - name: Stop processes
      run: |
        kill $(cat tap.pid) || true
        kill $(cat server.pid) || true

    - name: Validate capture.log
      run: |
        COUNT=$(grep -F "ASCII: hello world" capture.log | wc -l)
        echo "Found: $COUNT"
        if [ "$COUNT" -ne 2 ]; then
          echo "ERROR: Expected 2 occurrences of 'ASCII: hello world', got $COUNT"
          exit 1
        fi
